// lib/fortuneCookie.ts
import { randomUUID } from 'node:crypto';

export type FortuneKind = 'fortune' | 'fact';

export type FortuneResult = {
  kind: FortuneKind;
  text: string;
};

const FORTUNE_POOL: readonly string[] = [
  // 1–35: «гороскопные» ободряшки про удачный день
  'Сегодня, ИМЯ_ОТЧЕСТВО, обстоятельства неожиданно выстроятся в Вашу пользу, даже если начнутся не слишком ровно.',
  'Вам сегодня стоит прислушаться к мелочам: одна из них приведёт к хорошему исходу, ИМЯ_ОТЧЕСТВО.',
  'Денёк начнётся осторожно, но закончится приятным ощущением удачного поворота, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, кто-то сегодня скажет Вам фразу, после которой всё начнёт складываться легче.',
  'День подарит Вам небольшой знак, и Вы заметите, что он ведёт к чему-то хорошему, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, сегодня Вам будет удивительно легко принимать правильные решения.',
  'Ситуация, которая тянулась слишком долго, наконец-то сдвинется, и это будет к лучшему, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, удача сегодня выберет тихий путь, но выберет точно Вас.',
  'Даже если день покажется хаотичным, он завершится удивительно мягко, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, какой-то человек сегодня подарит Вам больше уважения, чем Вы ожидали.',
  'Сегодняшнее утро может быть сумбурным, но вечер обещает справедливость, ИМЯ_ОТЧЕСТВО.',
  'Ожидание от дня будет ниже, чем его итог, и итог приятно удивит Вас, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, сегодня Вы почувствуете, что выбрали верное направление.',
  'Сегодня Вы заметите, как день тихо подталкивает Вас к удачному решению, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, даже непростая ситуация сегодня обернётся неожиданно спокойно.',
  'Сегодняшний день завершится лучше, чем начнётся, и Вы это оцените, ИМЯ_ОТЧЕСТВО.',
  'В середине дня Вы поймёте, что всё идёт ровнее, чем казалось утром, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, один небольшой шаг сегодня даст больше результата, чем обычно.',
  'День будет щедр на маленькие удачные развороты, и один точно станет Вашим, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, спокойствие сегодня придёт само, когда Вы меньше всего будете его ждать.',
  'Кто-то сегодня посмотрит на Вас с уважением, которого раньше не показывал, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, Вы сегодня удивитесь, насколько мягко решается то, что раньше казалось острым.',
  'Слова, сказанные сегодня, отзовутся для Вас добрым эффектом, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, день аккуратно напомнит Вам, что Вы движетесь в правильную сторону.',
  'Сегодня Вы поймаете момент, когда всё начинает складываться легче, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, какая-то мелкая случайность сегодня окажется для Вас удачной.',
  'Даже если план немного изменится, итог дня Вас устроит, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, Ваше внутреннее ощущение «всё наладится» сегодня окажется точным.',
  'Одна встреча сегодня обернётся спокойным, но важным результатом, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, день подарит Вам ясный момент понимания, который давно был нужен.',
  'Сегодня обстоятельства проявят к Вам уважение и дадут больше пространства для манёвра, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, в какой-то момент Вы почувствуете, что день стал к Вам мягче.',
  'Даже если что-то пойдёт не по плану, финал дня будет на Вашей стороне, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, сегодняшний день сделает один из следующих шагов заметно легче.',
  'Сегодня Вы поймёте, что некоторые вещи всё-таки складываются честно, ИМЯ_ОТЧЕСТВО.',

  // 36–70: про заботу, отдых, спокойствие, радость
  'Сегодня днём Вы вдруг поймёте, ИМЯ_ОТЧЕСТВО, что напряжение спало само собой и дышится легче.',
  'В какой-то момент дня Вас накроет тихое ощущение отдыха, ИМЯ_ОТЧЕСТВО, даже если Вы его не планировали.',
  'Мир сегодня обойдётся с Вами деликатно, ИМЯ_ОТЧЕСТВО, и даст шанс замедлиться.',
  'Вашему вниманию подарят минуту тишины, ИМЯ_ОТЧЕСТВО, и она окажется удивительно ценной.',
  'Сегодня Вы поймёте, ИМЯ_ОТЧЕСТВО, что одну маленькую радость вполне можно позволить.',
  'Когда день покажется плотным, ИМЯ_ОТЧЕСТВО, он неожиданно раздвинется, давая Вам пространство.',
  'Ваша усталость сегодня встретит мягкий противовес, и Вы это заметите, ИМЯ_ОТЧЕСТВО.',
  'Сегодня к Вам придёт чувство спокойствия там, где Вы его не ждали, ИМЯ_ОТЧЕСТВО.',
  'Небольшая пауза подарит Вам больше сил, чем обычно, ИМЯ_ОТЧЕСТВО.',
  'Вы сегодня услышите тихую радостную новость, и она согреет, ИМЯ_ОТЧЕСТВО.',
  'День напомнит Вам, ИМЯ_ОТЧЕСТВО, что отдых иногда приходит сам, если дать ему шанс.',
  'Даже короткая прогулка сегодня даст Вам больше мира внутри, чем Вы рассчитывали, ИМЯ_ОТЧЕСТВО.',
  'Кто-то сегодня проявит о Вас заботу, ИМЯ_ОТЧЕСТВО, и это будет особенно вовремя.',
  'Ваше внутреннее спокойствие окажется заразительным, ИМЯ_ОТЧЕСТВО, и люди вокруг помогут его сохранить.',
  'Сегодня Вы найдёте минуту для себя, и она восстановит больше, чем час, ИМЯ_ОТЧЕСТВО.',
  'Радость сегодня придёт не громко, но честно, ИМЯ_ОТЧЕСТВО.',
  'Тот, кто обычно торопит, сегодня оставит Вас в покое, ИМЯ_ОТЧЕСТВО.',
  'Сегодняшний день будет мягче на ощупь, чем вчерашний, ИМЯ_ОТЧЕСТВО.',
  'Спокойствие найдёт Вас само в самый правильный момент, ИМЯ_ОТЧЕСТВО.',
  'Вам сегодня будет легко улыбнуться, потому что повод найдётся, ИМЯ_ОТЧЕСТВО.',
  'Небольшой жест доброжелательности сегодня станет для Вас источником радости, ИМЯ_ОТЧЕСТВО.',
  'В какой-то момент дня Вы ощутите лёгкость, ИМЯ_ОТЧЕСТВО, будто время стало добрее.',
  'Сегодня Вас обойдёт всё лишнее, а нужное подойдёт само, ИМЯ_ОТЧЕСТВО.',
  'Вы сегодня удивитесь, насколько спокойно можно прожить даже насыщенный день, ИМЯ_ОТЧЕСТВО.',
  'Радость пройдёт мимо многих, но Вас точно не пропустит, ИМЯ_ОТЧЕСТВО.',
  'День окажется щедрым на мягкие моменты, ИМЯ_ОТЧЕСТВО.',
  'Вам сегодня удастся сохранить равновесие без лишних усилий, ИМЯ_ОТЧЕСТВО.',
  'Какой-то приятный знак легонько напомнит Вам о себе, ИМЯ_ОТЧЕСТВО.',
  'Сегодня Вы почувствуете себя в безопасности там, где обычно держите оборону, ИМЯ_ОТЧЕСТВО.',
  'Силы вернутся быстрее, чем Вы ожидаете, ИМЯ_ОТЧЕСТВО.',
  'День принесёт Вам мирное настроение, ИМЯ_ОТЧЕСТВО, и это станет лучшей частью суток.',
  'Один человек сегодня подарит Вам светлый момент искренности, ИМЯ_ОТЧЕСТВО.',
  'В небольшой паузе Вы услышите тишину, которая лечит, ИМЯ_ОТЧЕСТВО.',
  'Радость сегодня выберет дорогу к Вам, ИМЯ_ОТЧЕСТВО, не спрашивая разрешения.',
  'Конец дня подарит то самое мягкое ощущение, что всё идёт правильно, ИМЯ_ОТЧЕСТВО.',

  // 71–105: про профессионализм, признание, успех, удачу и уважение
  'Сегодня Ваш профессионализм, ИМЯ_ОТЧЕСТВО, заметят раньше, чем Вы успеете что-то объяснить.',
  'Начальство посмотрит на Вас с тем самым вниманием, ИМЯ_ОТЧЕСТВО, которое обычно достаётся только людям, умеющим держать уровень.',
  'Один рабочий момент сегодня повернётся удачной стороной, ИМЯ_ОТЧЕСТВО, и это станет началом большего.',
  'Ваша компетентность сегодня станет очевиднее даже для тех, кто обычно не замечает очевидного, ИМЯ_ОТЧЕСТВО.',
  'Уважение, которого Вы заслуживали, сегодня проявится в конкретных словах, ИМЯ_ОТЧЕСТВО.',
  'День даст Вам шанс мягко, но уверенно показать свой профессиональный класс, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, сегодня Ваше мнение окажется решающим, хотя Вы этого и не добивались.',
  'Один Ваш точный шаг откроет хороший результат, и это заметят, ИМЯ_ОТЧЕСТВО.',
  'Удача сегодня будет идти с Вами ровно, ИМЯ_ОТЧЕСТВО, помогая в нужных местах.',
  'Человек, который редко признаёт чужие заслуги, сегодня признает Ваши, ИМЯ_ОТЧЕСТВО.',
  'Ваши решения сегодня окажутся удивительно своевременными, ИМЯ_ОТЧЕСТВО.',
  'День принесёт Вам уважение именно в той форме, которая ценится больше всего, ИМЯ_ОТЧЕСТВО.',
  'Там, где многие запутаются, Вы сегодня увидите прямую линию, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, руководство сегодня воспримет Вашу позицию как корректную и дальновидную.',
  'Рабочий вопрос, который казался тяжёлым, поддастся легче, чем ожидалось, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, Вы сегодня закрепите репутацию человека, на которого можно опереться.',
  'Ваш профессиональный авторитет сегодня усилится без единого громкого слова, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, удачный момент подойдёт как раз тогда, когда Вы будете к нему готовы.',
  'Даже строгое руководство сегодня проявит к Вам уважение, ИМЯ_ОТЧЕСТВО.',
  'Ваш опыт сегодня приведёт Вас к точному решению, которое оценят коллеги, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, день даст Вам возможность показать, что Вы видите глубже, чем остальные.',
  'Кто-то сегодня услышит Ваши слова особенно серьёзно, ИМЯ_ОТЧЕСТВО.',
  'Успех придёт не громко, но ровно туда, где он нужен Вам, ИМЯ_ОТЧЕСТВО.',
  'Ваше профессиональное спокойствие сегодня станет сигналом уверенности для окружающих, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, Вы сегодня избежите неприятностей лишь потому, что вовремя заметите деталь.',
  'Небольшое достижение сегодня получит больший вес, чем Вы ожидали, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, день создаст ситуацию, в которой Ваша сила станет очевидной.',
  'То, что Вы делаете качественно, сегодня оценят честно, ИМЯ_ОТЧЕСТВО.',
  'Удача в делах сегодня будет на Вашей стороне в те моменты, где важна точность, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, кто-то приведёт Вас в пример как человека, умеющего держать уровень.',
  'Рабочий день сегодня принесёт Вам ровный, спокойный успех, ИМЯ_ОТЧЕСТВО.',
  'ИМЯ_ОТЧЕСТВО, Вы удивитесь, насколько высоко оценят Ваше спокойствие и рассудительность.',
  'Сегодняшние решения укрепят Ваш авторитет, ИМЯ_ОТЧЕСТВО, и это почувствуется сразу.',
  'ИМЯ_ОТЧЕСТВО, в одном вопросе судьба сегодня сделает для Вас лёгкую, но очень точную поправку в лучшую сторону.',
  'Начальство увидит в Вас человека, который делает всё правильно и вовремя, ИМЯ_ОТЧЕСТВО.',
];

const FACT_POOL: readonly string[] = [
  // 1–30: обычные интересные факты
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что муравьи умеют обучать друг друга маршрутам, специально замедляясь, чтобы "ученик" успевал за ними?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что дельфины спят по полмозга: одна половина мозга бодрствует, а другая в это время отдыхает?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что на Марсе закаты имеют голубой цвет, а не красный, из-за особенностей атмосферы?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что стрекозы считаются одними из самых точных хищников на Земле: их эффективность охоты достигает примерно 95 процентов?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что у осьминога три сердца: два перекачивают кровь через жабры, а одно — по остальному телу?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что вкусовые рецепторы у бабочек находятся не во рту, а на лапках?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что северное сияние наблюдается не только на Земле, но и на Юпитере с Сатурном?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что белки иногда делают ложные "схроны", чтобы запутать тех, кто за ними наблюдает и может украсть запас?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что золотые рыбки способны запоминать информацию на месяцы, а не на секунды, как принято считать в мифах?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что отпечатки шагов на Луне могут сохраняться миллионы лет, потому что там нет ветра и дождя?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что пингвины в период ухаживания дарят друг другу камни, и это часть их брачного ритуала?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что колибри — единственные птицы, которые могут летать назад и зависать на месте?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что киты поют "диалектами": разные группы одного вида можно отличить по особенностям их песен?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что шмели учатся быстрее, если видят, как другую задачу уже выполняет другой шмель?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что бегемоты выделяют особую розоватую жидкость, которая работает как естественный крем от солнца?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что синие киты по громкости звука превосходят реактивный двигатель, хотя большую часть их сигналов человек не слышит?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что вороны запоминают лица людей на годы и отличают доброжелательных от опасных по поведению?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что улитки могут спать год и дольше, если условия вокруг слишком неблагоприятны для жизни?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что первые письменные домашние задания известны по шумерским глиняным табличкам возрастом более четырёх тысяч лет?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что некоторые виды лилий могут как бы "пульсировать" запахом, усиливая его в определённые часы суток?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что у осьминогов и кальмаров есть способность изменять цвет кожи почти мгновенно, благодаря особым клеткам-хроматофорам?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что пчёлы способны определять время суток по положению солнца даже в пасмурную погоду?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что летучие мыши — единственные млекопитающие, которые умеют по-настоящему летать, а не только планировать?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что гигантские черепахи могут доживать до 150 лет и помнить людей десятилетиями?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что некоторые кальмары умеют менять форму тела так, что становятся похожи на камни или водоросли?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что на большой глубине океана давление в тысячи раз выше, чем у поверхности, но рыбы спокойно живут и там?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что у деревьев и грибов в почве есть целые "сети", по которым растения обмениваются питательными веществами?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что песок в некоторых пустынях может "петь", издавая низкие звуки при движении больших масс?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что на Венере сутки по длительности длиннее местного года из-за очень медленного вращения планеты?',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, что стрекозы имеют две пары крыльев, которые могут работать независимо, благодаря чему они летают боком и назад?',

  // 31–50: латинские афоризмы с переводом и краткой справкой
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, латинский афоризм «Carpe diem» переводится как «Лови день». Краткая справка: фраза восходит к поэту Горацию и напоминает о ценности настоящего момента.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, выражение «Festina lente» значит «Спеши медленно». Краткая справка: девиз приписывают императору Августу, он о взвешенной осторожной решительности.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, афоризм «Non scholae sed vitae discimus» переводится как «Мы учимся не для школы, а для жизни». Краткая справка: формула популярна со времён Сенеки и стала девизом системы образования.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, фраза «Per aspera ad astra» означает «Через тернии к звёздам». Краткая справка: её использовали римские авторы, позже она стала символом преодоления трудностей.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, выражение «Aqua profunda est quieta» переводится как «Глубокие воды спокойны». Краткая справка: пословица подчёркивает, что истинная сила и глубина не нуждаются в шуме.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, афоризм «Verba volant, scripta manent» значит «Слова улетают, написанное остаётся». Краткая справка: формула активно использовалась в юридической практике Рима.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, выражение «Tempora mutantur, et nos mutamur in illis» переводится как «Времена меняются, и мы меняемся вместе с ними». Краткая справка: мысль возникла в поздней латинской традиции и стала философским комментарием к изменениям эпох.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, фраза «Audentis fortuna iuvat» означает «Счастье помогает смелым». Краткая справка: по свидетельствам, её употреблял Вергилий, подчёркивая роль решительности.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, афоризм «Divide et impera» переводится как «Разделяй и властвуй». Краткая справка: принцип приписывают римской политической традиции, описывая способ управления сложными системами.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, выражение «Veni, vidi, vici» значит «Пришёл, увидел, победил». Краткая справка: так, по Плутарху, Юлий Цезарь описал одну из своих стремительных побед.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, пословица «Fortes fortuna adiuvat» тоже переводится как «Удача помогает смелым». Краткая справка: вариации этой формулы встречаются у нескольких римских авторов и подчёркивают ценность активности.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, фраза «Memento vivere» означает «Помни жить». Краткая справка: позднелатинский ответ строгому «memento mori», напоминание не забывать о радости жизни.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, выражение «Nulla dies sine linea» переводится как «Ни дня без линии». Краткая справка: фраза о художнике, который каждый день делал хотя бы один штрих, стала девизом ежедневного труда.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, афоризм «Doctor bonae voluntatis» можно перевести как «Учитель доброй воли». Краткая справка: так в поздних текстах называли наставника, который работает не только ради формальной обязанности.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, фраза «Acta non verba» означает «Дела, а не слова». Краткая справка: лаконичный девиз, подчёркивающий приоритет действия над обещаниями.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, выражение «Omnia tempus habent» переводится как «Всему своё время». Краткая справка: мысль перекликается с античными и библейскими текстами о мере и своевременности.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, афоризм «Ars longa, vita brevis» значит «Искусство долговечно, жизнь коротка». Краткая справка: латинская форма восходит к греческому врачу Гиппократу и говорит о длинном пути мастерства.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, фраза «Non multa, sed multum» переводится как «Не многое, но глубоко». Краткая справка: принцип классического образования, ориентированного на качество, а не количество.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, выражение «Etiam si omnes, ego non» можно перевести как «Даже если все, я — нет». Краткая справка: формула внутренней принципиальности и отказа идти за большинством.',
  'Знали ли Вы, ИМЯ_ОТЧЕСТВО, афоризм «Sapere aude» означает «Имей мужество пользоваться собственным разумом». Краткая справка: с XVIII века выражение стало девизом Просвещения и интеллектуальной честности.',
];

function formatDateKey(date: Date): string {
  const year = date.getFullYear();
  const month = `${date.getMonth() + 1}`.padStart(2, '0');
  const day = `${date.getDate()}`.padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function simpleHash(input: string): number {
  // простой детерминированный хеш, без криптографии
  let hash = 0;
  for (let i = 0; i < input.length; i += 1) {
    const ch = input.charCodeAt(i);
    hash = (hash * 31 + ch) | 0;
  }
  if (hash === 0) {
    hash = 1;
  }
  return hash;
}

function pickFromPool(pool: readonly string[], seed: string): string {
  if (pool.length === 0) {
    return '';
  }
  const h = Math.abs(simpleHash(seed));
  const idx = h % pool.length;
  return pool[idx];
}

function resolveShortName(displayName: string | null | undefined): string {
  if (!displayName) return 'коллега';

  const parts = displayName.trim().split(/\s+/);
  if (parts.length === 0) return 'коллега';

  if (parts.length === 1) {
    // одно слово, оставляем как есть
    return parts[0];
  }

  if (parts.length === 2) {
    // "Имя Отчество" или "Имя Фамилия" — берём оба
    return `${parts[0]} ${parts[1]}`;
  }

  // классический вариант "Фамилия Имя Отчество" и длиннее:
  // отбрасываем фамилию, берём имя и отчество
  return `${parts[1]} ${parts[2]}`;
}

export function getDailyFortune(options: {
  userId?: string | null;
  displayName?: string | null;
  role?: string | null;
  now?: Date;
}): FortuneResult {
  const now = options.now ?? new Date();
  const dateKey = formatDateKey(now);

  const userId =
    options.userId && options.userId.trim().length > 0
      ? options.userId
      : randomUUID(); // для анонима, чтобы всё равно был детерминизм в течение дня сессии

  const seedBase = `${userId}:${dateKey}`;

  // распределение: 0–5 → fortune, 6–9 → fact
  const hKind = Math.abs(simpleHash(`${seedBase}:kind`));
  const bucket = hKind % 10;

  let kind: FortuneKind;
  let rawText: string;

  if (bucket <= 5 && FORTUNE_POOL.length > 0) {
    kind = 'fortune';
    rawText = pickFromPool(FORTUNE_POOL, `${seedBase}:fortune`);
  } else if (FACT_POOL.length > 0) {
    kind = 'fact';
    rawText = pickFromPool(FACT_POOL, `${seedBase}:fact`);
  } else if (FORTUNE_POOL.length > 0) {
    kind = 'fortune';
    rawText = pickFromPool(FORTUNE_POOL, `${seedBase}:fallback`);
  } else {
    kind = 'fortune';
    rawText = 'Сегодня система молчит, но у Вас всё равно всё получится.';
  }

  const name = resolveShortName(options.displayName);
  const text = rawText.replace(/ИМЯ_ОТЧЕСТВО/g, name);

  return { kind, text };
}
